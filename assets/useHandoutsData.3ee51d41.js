import{r as m,an as ee,ao as te,c as p,a as ae,ap as oe}from"./index.be84e892.js";const ne="zoskycube",re="zoskycube",D=m(!1),G=m(!1),W=m(null),Y=m(null),B=ee([]),se=500,b=m([]),h=te({byUser:new Map});let _=null;const v={vodvote_entry:/ðŸ—³ï¸ @([a-zA-Z0-9_]+) \+(\d+) = [\d.]+k? zoskycUbe vodVoted 4 "([^"]+)"/,vodvote_start:/ðŸš¦ @([a-zA-Z0-9_]+) \+(\d+) = [\d.]+k? zoskycUbe reStarted vodVote!/,vodvote_start_alt:/ðŸš¦ zoskycCubeGG @([a-zA-Z0-9_]+) started a new game/,vodvote_win:/ðŸŽ‰ \+(\d+) @([a-zA-Z0-9_]+) for picking "([^"]+)"/,vodvote_unpicked:/ðŸ˜¢ No one picked "([^"]+)", & "([^"]+)" was picked the most/,art_success:/ðŸŽ¨ @([a-zA-Z0-9_]+) âœ… '([^']+)'! \+(\d+) zoskycUbe = [\d.]+k? zoskycUbe/,art_success_alt:/ðŸŽ¨ @([a-zA-Z0-9_]+) \+(\d+) = [\d.]+k? zoskycUbe for "([^"]+)"/,art_penalty:/ðŸŽ¨ @([a-zA-Z0-9_]+) ðŸŸ¨ (.+)/,art_wrong_letter:/ðŸ”¤ @([a-zA-Z0-9_]+) each round needs words starting with the letter on stream!/,art_already_submitted:/ðŸ”„ @([a-zA-Z0-9_]+) You've added your word this round!/,art_not_dictionary:/ðŸ“– @([a-zA-Z0-9_]+) "([^"]+)" is not a valid/,art_duplicate:/âŒ @([a-zA-Z0-9_]+) Word already submitted recently/,zz_match_start:/ðŸ¦ goTime! ([a-zA-Z0-9_]+) vs ([a-zA-Z0-9_]+)\./,zz_pve_start:/ðŸ¤– PvE started: ([a-zA-Z0-9_]+) vs AI/,zz_win:/âš¡ âœ… @([a-zA-Z0-9_]+).*?(\d+) Ws? win: (\d+)(?:\+(\d+))? = (\d+) zoskycUbe/,zz_win_first:/âš¡ âœ… @([a-zA-Z0-9_]+) ðŸŽ‰ 1st W win: (\d+) zoskycUbe = (\d+) zoskycUbe/,zz_loss:/âš¡ â˜ ï¸ @([a-zA-Z0-9_]+) \+(\d+) zoskycUbe for participation\. get gud/,zz_invalid_code:/ðŸš« @([a-zA-Z0-9_]+) invalid code\./,zz_wait_turn:/ðŸ¤ @([a-zA-Z0-9_]+) wait for your turn!/,achievement_unlock:/ðŸ† (.+?) \((\d+(?:\.\d+)?%?)\s*(?:rarity)?\) \+(\d+) = [\d,]+ zoskycUbe/,achievement_unlock_alt:/ðŸ† (.+) \((\d+)% rarity\) \+(\d+)zC = [\d,]+ zCubes/,death_event:/[ðŸ’€âš°ï¸] (?:Death )?(\d+)(?: deaths?)?\. .+ -(\d+) = [\d,]+ zoskycUbe/,death_event_alt:/[ðŸ’€âš°ï¸] (\d+) deaths?\. .+ -(\d+) = [\d,]+ zoskycUbe/,dailydose:/@([a-zA-Z0-9_]+) = dailyDose \+1k @ 1:1 rate \| now has [\d,]+ zC ðŸ’Š/,voucher:/@([a-zA-Z0-9_]+) âœ… ([\d,]+) zCubes awarded!/,milestone:/@([a-zA-Z0-9_]+) \d+(?:st|nd|rd|th) to \d+k\. .+ zoskycCubeGG/,game_end:/ðŸ (.+?) â° [\d:]+ â˜ ï¸ (\d+) \(ðŸŸ¥(-?\d+)zC\) ðŸ† (\d+) \(ðŸŸ¦\+?(\d+)zC\) = (-?\d+) zCubes/,whitelist_complete:/ðŸŽ‰ @([a-zA-Z0-9_]+) whitelist complete!/,invalid_vote:/ðŸ¤–\? @([a-zA-Z0-9_]+) Invalid vote code!/,voting_not_open:/ðŸš« @([a-zA-Z0-9_]+) Voting is not open!/,feedback_submitted:/ðŸ“º @([a-zA-Z0-9_]+) feedback submitted!/};function ue(t){const e=t.toLowerCase();return h.byUser.has(e)||h.byUser.set(e,{username:e,totalAmount:0,totalCount:0,lastActivity:Date.now(),byGame:{vodVote:{amount:0,count:0},art:{amount:0,count:0},zoskyZappers:{amount:0,count:0},chevos:{amount:0,count:0},voucher:{amount:0,count:0}}}),h.byUser.get(e)}function y(t,e,o,r){const s=Date.now(),c={username:t.toLowerCase(),amount:e,reason:o,source:r,timestamp:s,date:new Date(s).toISOString().split("T")[0],day:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][new Date(s).getDay()],hour:new Date(s).getHours(),dayOfWeek:new Date(s).getDay(),isRealtime:!0};b.value.unshift(c),b.value.length>1e3&&b.value.pop();const u=ue(t);u.totalAmount+=e,u.totalCount++,u.lastActivity=s,r&&u.byGame[r]&&(u.byGame[r].amount+=e,u.byGame[r].count++),console.log(`\u{1F3AF} [TwitchChat] ${t} +${e} (${r}): ${o}`)}function ce(t){let e=t.match(v.vodvote_entry);if(e){const[,o,r,s]=e;return y(o,parseInt(r),`VOD Voted for "${s}"`,"vodVote"),!0}if(e=t.match(v.vodvote_start),e){const[,o,r]=e;return y(o,parseInt(r),"Started VOD Vote","vodVote"),!0}if(e=t.match(v.vodvote_win),e){const[,o,r,s]=e;return y(r,parseInt(o),`VOD Vote win: "${s}"`,"vodVote"),!0}if(e=t.match(v.art_success),e){const[,o,r,s]=e;return y(o,parseInt(s),`Pixel Power: "${r}"`,"art"),!0}if(e=t.match(v.art_success_alt),e){const[,o,r,s]=e;return y(o,parseInt(r),`Pixel Power: "${s}"`,"art"),!0}if(e=t.match(v.zz_win),e){const[,o,r,s,c,u]=e,l=parseInt(s)+(c?parseInt(c):0);return y(o,l,`zZ ${r}W win`,"zoskyZappers"),!0}if(e=t.match(v.zz_win_first),e){const[,o,r,s]=e;return y(o,parseInt(r),"zZ 1st W win","zoskyZappers"),!0}if(e=t.match(v.zz_loss),e){const[,o,r]=e;return y(o,parseInt(r),"zZ participation","zoskyZappers"),!0}if(e=t.match(v.achievement_unlock),e){const[,o,r,s]=e;return y("zoskycube",parseInt(s),`Achievement: ${o}`,"chevos"),!0}if(e=t.match(v.dailydose),e){const[,o]=e;return y(o,1e3,"dailyDose redemption","voucher"),!0}if(e=t.match(v.voucher),e){const[,o,r]=e,s=parseInt(r.replace(/,/g,""));return y(o,s,"Voucher redemption","voucher"),!0}return!1}function le(t,e,o,r){var c;const s={timestamp:Date.now(),username:e.username,message:o,displayName:e["display-name"]};B.value=[s,...B.value.slice(0,se-1)],Y.value=s,((c=e.username)==null?void 0:c.toLowerCase())===re&&ce(o)}async function ie(){if(D.value||G.value)return console.log("\u{1F517} [TwitchChat] Already connected or connecting"),!0;G.value=!0,W.value=null;try{const t=await oe(()=>import("./index.d8340669.js").then(e=>e.i),[]);return _=new t.default.Client({options:{debug:!1},connection:{reconnect:!0,secure:!0},channels:[ne]}),_.on("message",le),_.on("connected",(e,o)=>{console.log(`\u2705 [TwitchChat] Connected to ${e}:${o}`),D.value=!0,G.value=!1}),_.on("disconnected",e=>{console.log(`\u274C [TwitchChat] Disconnected: ${e}`),D.value=!1}),_.on("reconnect",()=>{console.log("\u{1F504} [TwitchChat] Reconnecting...")}),await _.connect(),!0}catch(t){return console.error("\u274C [TwitchChat] Connection failed:",t),W.value=t.message,G.value=!1,!1}}async function me(){if(!!_)try{await _.disconnect(),_=null,D.value=!1,console.log("\u{1F44B} [TwitchChat] Disconnected")}catch(t){console.error("\u26A0\uFE0F [TwitchChat] Disconnect error:",t)}}function J(t){return h.byUser.get(t.toLowerCase())||null}function de(t){const e=t.toLowerCase();return b.value.filter(o=>o.username===e)}function ve(t,e){var r,s,c,u,l,d,z,A,Z,g,U,S,$,V,E,I,L,R,n,i;const o=J(t);return o?{...e,totalAmount:e.totalAmount+o.totalAmount,totalCount:e.totalCount+o.totalCount,byGame:{vodVote:{amount:(((s=(r=e.byGame)==null?void 0:r.vodVote)==null?void 0:s.amount)||0)+o.byGame.vodVote.amount,count:(((u=(c=e.byGame)==null?void 0:c.vodVote)==null?void 0:u.count)||0)+o.byGame.vodVote.count},art:{amount:(((d=(l=e.byGame)==null?void 0:l.art)==null?void 0:d.amount)||0)+o.byGame.art.amount,count:(((A=(z=e.byGame)==null?void 0:z.art)==null?void 0:A.count)||0)+o.byGame.art.count},zoskyZappers:{amount:(((g=(Z=e.byGame)==null?void 0:Z.zoskyZappers)==null?void 0:g.amount)||0)+o.byGame.zoskyZappers.amount,count:(((S=(U=e.byGame)==null?void 0:U.zoskyZappers)==null?void 0:S.count)||0)+o.byGame.zoskyZappers.count},chevos:{amount:(((V=($=e.byGame)==null?void 0:$.chevos)==null?void 0:V.amount)||0)+o.byGame.chevos.amount,count:(((I=(E=e.byGame)==null?void 0:E.chevos)==null?void 0:I.count)||0)+o.byGame.chevos.count},voucher:{amount:(((R=(L=e.byGame)==null?void 0:L.voucher)==null?void 0:R.amount)||0)+o.byGame.voucher.amount,count:(((i=(n=e.byGame)==null?void 0:n.voucher)==null?void 0:i.count)||0)+o.byGame.voucher.count}}}:e}const fe=p(()=>Array.from(h.byUser.values()).sort((t,e)=>e.totalAmount-t.totalAmount)),ye=p(()=>b.value.reduce((t,e)=>t+e.amount,0));function pe(t){if(!t||t<=0)return 0;const e=b.value.length;b.value=b.value.filter(r=>r.timestamp>t);const o=e-b.value.length;return o>0&&(console.log(`\u2702\uFE0F Pruned ${o} realtime entries (now in CSV)`),be()),o}function be(){h.byUser.clear(),b.value.forEach(t=>{h.byUser.has(t.username)||h.byUser.set(t.username,{username:t.username,totalAmount:0,totalCount:0,byGame:{}});const e=h.byUser.get(t.username);e.totalAmount+=t.amount,e.totalCount++,t.source&&(e.byGame[t.source]||(e.byGame[t.source]={amount:0,count:0}),e.byGame[t.source].amount+=t.amount,e.byGame[t.source].count++)})}function he(){return ae(()=>{}),{connect:ie,disconnect:me,isConnected:D,isConnecting:G,connectionError:W,lastMessage:Y,messageLog:B,realtimeHandouts:b,realtimeStats:h,realtimeLeaderboard:fe,realtimeTotalDistributed:ye,getUserRealtimeStats:J,getUserRealtimeHandouts:de,mergeWithUserStats:ve,pruneRealtimeHandouts:pe,PATTERNS:v}}const Q="668816ac484cab966df79977",we=60*60*1e3,w=m([]),j=m([]),M=m(!1),P=m(!1),F=m(null),K=m([]),x=m(null);let T=null;const H=m(null),C=m(null),k=m(!0),_e=p(()=>{var o,r;if(w.value.length===0)return{min:null,max:null};const t=(o=w.value[0])==null?void 0:o.timestamp,e=(r=w.value[w.value.length-1])==null?void 0:r.timestamp;return{min:e?new Date(e).toISOString().split("T")[0]:null,max:t?new Date(t).toISOString().split("T")[0]:null}});function ze(t){const e=t.trim().split(`
`);return e.length<2?[]:e.slice(1).map(o=>{var u;const r=[];let s="",c=!1;for(let l=0;l<o.length;l++){const d=o[l];d==='"'?c=!c:d===","&&!c?(r.push(s),s=""):s+=d}return r.push(s),{username:((u=r[0])==null?void 0:u.toLowerCase())||"",amount:parseInt(r[1])||0,reason:r[2]||"",source:r[3]||"",timestamp:parseInt(r[4])||0,date:r[5]||"",day:r[6]||"",hour:new Date(parseInt(r[4])).getHours(),dayOfWeek:new Date(parseInt(r[4])).getDay()}}).filter(o=>o.username&&o.timestamp)}async function ge(t,e,o=!1){const r=String(e).padStart(2,"0");let c=`//archive.zoskycube.com/data/handouts-${t}-${r}.csv`;o&&(c+=`?t=${Date.now()}`);try{const u=await fetch(c);if(!u.ok)return console.warn(`\u26A0\uFE0F CSV not found: ${c}`),[];const l=await u.text(),d=ze(l);return console.log(`\u2705 Loaded ${d.length} records from ${c}${o?" (cache-busted)":""}`),d}catch(u){return console.warn(`\u26A0\uFE0F Error loading ${c}:`,u.message),[]}}async function Ae(){try{const[t,e]=await Promise.all([fetch(`https://api.streamelements.com/kappa/v2/points/${Q}/top?limit=100&offset=0`),fetch(`https://api.streamelements.com/kappa/v2/points/${Q}/top?limit=100&offset=100`)]),o=t.ok?await t.json():{users:[]},r=e.ok?await e.json():{users:[]},s=[...o.users||[],...r.users||[]].map(c=>({username:c.username.toLowerCase(),points:c.points,rank:c.rank}));j.value=s,console.log(`\u2705 Loaded ${s.length} users from StreamElements leaderboard`)}catch(t){console.warn("\u26A0\uFE0F Error loading SE leaderboard:",t.message),j.value=[]}}const O=[{year:2025,month:11},{year:2025,month:12},{year:2026,month:1},{year:2026,month:2}];async function N(t=!1){if(!(M.value||P.value)){if(!t&&w.value.length>0){console.log("\u{1F4E6} Using cached handouts data");return}t?(P.value=!0,console.log("\u{1F504} Refreshing CSV data with cache bust...")):M.value=!0,F.value=null;try{const e=O.map(({year:u,month:l})=>ge(u,l,t)),o=Ae(),r=await Promise.all(e);await o;const s=r.flat().sort((u,l)=>l.timestamp-u.timestamp),c=s.length>0?s[0].timestamp:0;return w.value=s,x.value=Date.now(),K.value=O.map(({year:u,month:l})=>`${u}-${String(l).padStart(2,"0")}`),console.log(`\u{1F4CA} Total handouts loaded: ${w.value.length} from ${O.length} months`),c}catch(e){return console.error("\u274C Error loading handouts:",e),F.value=e.message,0}finally{M.value=!1,P.value=!1}}}function X(){if(T)return;const t=new Date,e=(60-t.getMinutes())*60*1e3-t.getSeconds()*1e3-t.getMilliseconds();console.log(`\u23F0 Next CSV refresh in ${Math.round(e/6e4)} minutes`),setTimeout(()=>{q(),T=setInterval(q,we)},e+5e3)}function Ce(){T&&(clearInterval(T),T=null,console.log("\u23F9\uFE0F Stopped CSV refresh timer"))}let q=null;function Ge(){const t=["zoskyZappers","vodVote","art","voucher","chevos"],{realtimeHandouts:e,realtimeStats:o,connect:r,isConnected:s,pruneRealtimeHandouts:c}=he();q=async()=>{console.log("\u{1F504} Hourly refresh triggered");const n=await N(!0);n>0&&c(n)};const u=p(()=>{let n=w.value;if(H.value){const i=new Date(H.value).getTime();n=n.filter(a=>a.timestamp>=i)}if(C.value&&!k.value){const i=new Date(C.value).getTime()+864e5;n=n.filter(a=>a.timestamp<=i)}return n}),l=p(()=>k.value),d=p(()=>l.value?[...e.value,...u.value]:u.value),z=p(()=>{const n={};u.value.forEach(a=>{n[a.username]||(n[a.username]={username:a.username,totalAmount:0,totalCount:0,lastActivity:0,currentBalance:0,realtimeAmount:0,realtimeCount:0,byGame:{}},t.forEach(f=>{n[a.username].byGame[f]={amount:0,count:0}})),a.source!=="redeem"&&(n[a.username].totalAmount+=a.amount,n[a.username].totalCount++),a.timestamp>n[a.username].lastActivity&&(n[a.username].lastActivity=a.timestamp),a.source&&n[a.username].byGame[a.source]&&(n[a.username].byGame[a.source].amount+=a.amount,n[a.username].byGame[a.source].count++)}),l.value&&e.value.forEach(a=>{n[a.username]||(n[a.username]={username:a.username,totalAmount:0,totalCount:0,lastActivity:0,currentBalance:0,realtimeAmount:0,realtimeCount:0,byGame:{}},t.forEach(f=>{n[a.username].byGame[f]={amount:0,count:0}})),a.source!=="redeem"&&(n[a.username].totalAmount+=a.amount,n[a.username].totalCount++,n[a.username].realtimeAmount+=a.amount,n[a.username].realtimeCount++),a.timestamp>n[a.username].lastActivity&&(n[a.username].lastActivity=a.timestamp),a.source&&n[a.username].byGame[a.source]&&(n[a.username].byGame[a.source].amount+=a.amount,n[a.username].byGame[a.source].count++)});const i={};return j.value.forEach(a=>{i[a.username]=a.points}),Object.values(n).map(a=>({...a,currentBalance:i[a.username]||0,avgAmount:a.totalCount>0?Math.round(a.totalAmount/a.totalCount):0})).sort((a,f)=>f.currentBalance-a.currentBalance)}),A=p(()=>{const n=u.value.filter(a=>a.source!=="redeem").reduce((a,f)=>a+f.amount,0),i=l.value?e.value.filter(a=>a.source!=="redeem").reduce((a,f)=>a+f.amount,0):0;return n+i}),Z=p(()=>e.value.filter(n=>n.source!=="redeem").reduce((n,i)=>n+i.amount,0)),g=p(()=>z.value.length),U=p(()=>g.value>0?Math.round(A.value/g.value):0);function S(n){if(!n)return[];const i=n.toLowerCase();return d.value.filter(a=>a.username===i)}function $(n){if(!n)return 0;const i=n.toLowerCase(),a=z.value.findIndex(f=>f.username===i);return a>=0?a+1:0}async function V(){w.value=[],await N()}async function E(){const n=await N(!0);n>0&&c(n)}async function I(){return X(),await r()}function L(n,i,a=!0){H.value=n,C.value=i,k.value=a}function R(n){k.value=n,n&&(C.value=null)}return{allHandouts:w,combinedHandouts:d,filteredHandouts:u,isLoading:M,isRefreshing:P,error:F,loadedMonths:K,lastRefreshTime:x,dateFrom:H,dateTo:C,isNowMode:k,availableDateRange:_e,realtimeHandouts:e,realtimeStats:o,isTwitchConnected:s,realtimeTotalDistributed:Z,leaderboard:z,totalDistributed:A,uniquePlayers:g,avgPerPlayer:U,loadData:N,reloadData:V,refreshData:E,getUserHandouts:S,getUserRank:$,connectRealtime:I,setDateRange:L,toggleNowMode:R,startRefreshTimer:X,stopRefreshTimer:Ce}}export{Ge as u};
